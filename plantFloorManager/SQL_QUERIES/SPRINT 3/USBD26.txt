CREATE OR REPLACE FUNCTION get_order_stock_status(
    p_customer_order_id IN NUMBER
) RETURN SYS_REFCURSOR IS
    -- Declare custom exceptions
    CUSTOMER_ORDER_ID_NULL EXCEPTION;
    CUSTOMER_ORDER_ID_NOT_FOUND EXCEPTION;

    -- Variables
    v_count INTEGER;
    v_result SYS.ODCIVARCHAR2LIST := SYS.ODCIVARCHAR2LIST();
    v_combined SYS_REFCURSOR;

    -- Cursor to retrieve stock data for external parts
    CURSOR c_order_stock IS
        SELECT
            cip.Part_ID,
            p.Part_Description,
            SUM(cip.Quantity * cop.Quantity) AS Total_Required_Quantity,
            cip.Unit AS Required_Unit,
            s.Stock AS Available_Stock,
            s.Unit AS Stock_Unit,
            CASE
                WHEN s.Stock >= SUM(cip.Quantity * cop.Quantity) THEN 'Sufficient'
                ELSE 'Insufficient'
            END AS Stock_Status
        FROM
            Customer_Order_Product cop
        JOIN
            BOO_Input cip ON cop.Product_ID = cip.Product_ID
        JOIN
            External_Part ep ON cip.Part_ID = ep.Part_ID
        LEFT JOIN
            Stock s ON cip.Part_ID = s.Part_ID
        JOIN
            Part p ON cip.Part_ID = p.Part_ID
        WHERE
            cop.Customer_Order_ID = p_customer_order_id
        GROUP BY
            cip.Part_ID, p.Part_Description, s.Stock, cip.Unit, s.Unit
        ORDER BY
            Stock_Status DESC, cip.Part_ID;
BEGIN
    -- Check if the order ID is NULL
    IF p_customer_order_id IS NULL THEN
        RAISE CUSTOMER_ORDER_ID_NULL;
    END IF;

    -- Check if the order ID exists in the Customer_Order_Product table
    SELECT COUNT(*)
    INTO v_count
    FROM Customer_Order_Product
    WHERE Customer_Order_ID = p_customer_order_id;

    IF v_count = 0 THEN
        RAISE CUSTOMER_ORDER_ID_NOT_FOUND;
    END IF;

    -- Iterate through the stock data
    FOR stock_row IN c_order_stock LOOP
        -- Store results in the collection
        v_result.EXTEND;
        v_result(v_result.COUNT) :=
            'Part ID: ' || stock_row.Part_ID || CHR(10) ||
            'Description: ' || stock_row.Part_Description || CHR(10) ||
            'Total Required: ' || TO_CHAR(stock_row.Total_Required_Quantity) || ' ' || stock_row.Required_Unit || CHR(10) ||
            'Stock: ' || NVL(TO_CHAR(stock_row.Available_Stock), '0') || ' ' || NVL(stock_row.Stock_Unit, 'N/A') || CHR(10) ||
            'Status: ' || stock_row.Stock_Status || CHR(10) ||
            '------------------------' || CHR(10);
    END LOOP;

    -- Return results as a reference cursor
    OPEN v_combined FOR
        SELECT column_value AS order_stock_data
        FROM TABLE(v_result);

    -- Return the reference cursor
    RETURN v_combined;

EXCEPTION
    WHEN CUSTOMER_ORDER_ID_NULL THEN
        RAISE_APPLICATION_ERROR(-20001, 'Customer Order ID cannot be NULL');

    WHEN CUSTOMER_ORDER_ID_NOT_FOUND THEN
        RAISE_APPLICATION_ERROR(-20002, 'Customer Order ID not found');
END GetOrderStockStatus;
/

-- Example usage of the function

-- Scenario 1: Customer Order ID Not Found
DECLARE
    v_result SYS_REFCURSOR;
    v_stock_data VARCHAR2(4000);
BEGIN
    DBMS_OUTPUT.PUT_LINE('Scenario 1: Customer Order ID Not Found');
    v_result := GetOrderStockStatus(1000);
    LOOP
        FETCH v_result INTO v_stock_data;
        EXIT WHEN v_result%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(v_stock_data);
    END LOOP;
    CLOSE v_result;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

-- Customer Order ID NULL
DECLARE
    v_result SYS_REFCURSOR;
    v_stock_data VARCHAR2(4000);
BEGIN
    DBMS_OUTPUT.PUT_LINE('Scenario 2: Customer Order ID NULL');
    v_result := GetOrderStockStatus(NULL);
    LOOP
        FETCH v_result INTO v_stock_data;
        EXIT WHEN v_result%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(v_stock_data);
    END LOOP;
    CLOSE v_result;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

-- Scenario 3: Valid Customer Order ID
DECLARE
    v_result SYS_REFCURSOR;
    v_stock_data VARCHAR2(4000);
BEGIN
    DBMS_OUTPUT.PUT_LINE('Scenario 3: Valid Customer Order ID');
    v_result := GetOrderStockStatus(4);
    LOOP
        FETCH v_result INTO v_stock_data;
        EXIT WHEN v_result%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(v_stock_data);
    END LOOP;
    CLOSE v_result;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/
