CREATE OR REPLACE FUNCTION Get_Product_Operations(p_product_id IN VARCHAR2)
    RETURN SYS_REFCURSOR
IS
    v_cursor SYS_REFCURSOR;
BEGIN
    OPEN v_cursor FOR
        WITH Recursive_Parts (Product_ID, Operation_ID, Input_Part, Output_Part, Execution_Time, Operation_Description, Part_Type) AS (
            -- Recursively find all parts for the given product
            SELECT
                b.Product_ID AS Product_ID,
                b.Operation_ID AS Operation_ID,
                bi.Part_ID AS Input_Part,
                bo.Part_ID AS Output_Part,
                o.Expected_Estimated_Time AS Execution_Time,
                ot.Operation_Description AS Operation_Description,
                CASE
                    WHEN i.Part_ID IS NOT NULL THEN 'Internal'
                    ELSE 'External'
                END AS Part_Type
            FROM
                BOO b
                    LEFT JOIN
                Operation o ON b.Operation_ID = o.Operation_ID
                    LEFT JOIN
                Operation_Type ot ON o.Operation_Type_ID = ot.Operation_Type_ID
                    LEFT JOIN
                BOO_Input bi ON b.Operation_ID = bi.Operation_ID AND b.Product_ID = bi.Product_ID
                    LEFT JOIN
                BOO_Output bo ON b.Operation_ID = bo.Operation_ID AND b.Product_ID = bo.Product_ID
                    LEFT JOIN
                Internal_Part i ON bi.Part_ID = i.Part_ID
                    LEFT JOIN
                External_Part e ON bi.Part_ID = e.Part_ID
            WHERE
                b.Product_ID = p_product_id -- Start from the given product

            UNION ALL

            SELECT
                b.Product_ID AS Product_ID,
                b.Operation_ID AS Operation_ID,
                bi.Part_ID AS Input_Part,
                bo.Part_ID AS Output_Part,
                o.Expected_Estimated_Time AS Execution_Time,
                ot.Operation_Description AS Operation_Description,
                CASE
                    WHEN i.Part_ID IS NOT NULL THEN 'Internal'
                    ELSE 'External'
                END AS Part_Type
            FROM
                BOO b
                    JOIN Recursive_Parts rp ON rp.Input_Part = b.Product_ID
                    LEFT JOIN
                Operation o ON b.Operation_ID = o.Operation_ID
                    LEFT JOIN
                Operation_Type ot ON o.Operation_Type_ID = ot.Operation_Type_ID
                    LEFT JOIN
                BOO_Input bi ON b.Operation_ID = bi.Operation_ID AND b.Product_ID = bi.Product_ID
                    LEFT JOIN
                BOO_Output bo ON b.Operation_ID = bo.Operation_ID AND b.Product_ID = bo.Product_ID
                    LEFT JOIN
                Internal_Part i ON bi.Part_ID = i.Part_ID
                    LEFT JOIN
                External_Part e ON bi.Part_ID = e.Part_ID
        )
        SELECT
            Product_ID,
            Operation_ID,
            Operation_Description,
            Execution_Time,
            Part_Type,
            Input_Part,
            Output_Part
        FROM
            Recursive_Parts
        ORDER BY
            Product_ID, Operation_ID;

    RETURN v_cursor;
END;

-- Test block to execute the function
DECLARE
    v_cursor SYS_REFCURSOR;
    v_product_id VARCHAR2(255) := 'AS12945S22'; -- Example product ID

    -- Variables matching the output structure of the cursor
    v_product_id_out VARCHAR2(255);
    v_operation_id_out NUMBER;
    v_operation_description_out VARCHAR2(255);
    v_execution_time_out NUMBER;
    v_part_type_out VARCHAR2(20);
    v_input_part_out VARCHAR2(255);
    v_output_part_out VARCHAR2(255);
BEGIN
    v_cursor := Get_Product_Operations(v_product_id);

    LOOP
        FETCH v_cursor INTO
            v_product_id_out,
            v_operation_id_out,
            v_operation_description_out,
            v_execution_time_out,
            v_part_type_out,
            v_input_part_out,
            v_output_part_out;
        EXIT WHEN v_cursor%NOTFOUND;

        DBMS_OUTPUT.PUT_LINE('Product ID: ' || v_product_id_out);
        DBMS_OUTPUT.PUT_LINE('Operation ID: ' || v_operation_id_out);
        DBMS_OUTPUT.PUT_LINE('Operation Description: ' || v_operation_description_out);
        DBMS_OUTPUT.PUT_LINE('Execution Time: ' || v_execution_time_out);
        DBMS_OUTPUT.PUT_LINE('Part Type: ' || v_part_type_out);
        DBMS_OUTPUT.PUT_LINE('Input Part: ' || v_input_part_out);
        DBMS_OUTPUT.PUT_LINE('Output Part: ' || v_output_part_out);
        DBMS_OUTPUT.PUT_LINE('---------------------------------------');
    END LOOP;

    CLOSE v_cursor;
END;
