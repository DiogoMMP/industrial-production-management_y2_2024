CREATE OR REPLACE TRIGGER check_operation_execution_time
    BEFORE INSERT OR UPDATE ON Operation
    FOR EACH ROW
DECLARE
    max_allowed_time NUMBER;
    workstation_types VARCHAR2(4000);
    CURSOR compatible_workstations IS
        SELECT wto.Workstation_Type_ID
        FROM Workstation_Type_Operation_Type wto
        WHERE wto.Operation_Type_ID = :NEW.Operation_Type_ID;
BEGIN
    -- Initialize variables
    max_allowed_time := NULL;
    workstation_types := NULL;

    -- Obtain the maximum time allowed
    SELECT MIN(wto.Maximum_Execution_Time) -- MIN para obter o limite mais restritivo
    INTO max_allowed_time
    FROM Workstation_Type_Operation_Type wto
    WHERE wto.Operation_Type_ID = :NEW.Operation_Type_ID;

    -- Build a list of compatible station types
    FOR workstation IN compatible_workstations LOOP
        IF workstation_types IS NULL THEN
            workstation_types := workstation.Workstation_Type_ID;
        ELSE
            workstation_types := workstation_types || ', ' || workstation.Workstation_Type_ID;
        END IF;
    END LOOP;

    -- Check the expected operation time against the maximum allowed time
    IF max_allowed_time IS NOT NULL THEN
        IF :NEW.Expected_Estimated_Time > max_allowed_time THEN
            RAISE_APPLICATION_ERROR(-20001,
                'Operation Execution Time Violation:' || CHR(10) ||
                'Expected Time: ' || :NEW.Expected_Estimated_Time || CHR(10) ||
                'Maximum Allowed Time: ' || max_allowed_time || CHR(10) ||
                'Compatible Workstation Types: ' || workstation_types || CHR(10) ||
                'The operation''s expected execution time exceeds the allowed maximum.');
        END IF;
    END IF;
END;
/



-- Prerequisite: Create test data
INSERT INTO Operation_Type (Operation_Type_ID, Operation_Description)
VALUES (1, 'Test Operation Type');

INSERT INTO Workstation_Type (Workstation_Type_ID, Workstation_Type)
VALUES ('WT1', 'Test Workstation Type');

INSERT INTO Workstation_Type_Operation_Type
(Workstation_Type_ID, Operation_Type_ID, Maximum_Execution_Time, Setup_Time)
VALUES ('WT1', 1, 100, 10);

-- Test 1: Successful insertion
DECLARE
    v_success BOOLEAN := TRUE;
BEGIN
    -- Insert an operation with an expected execution time within the allowed limit
    INSERT INTO Operation (Operation_ID, Operation_Type_ID, Expected_Estimated_Time)
    VALUES (1, 1, 90);
    DBMS_OUTPUT.PUT_LINE('Test 1 Passed: Insertion within limit');
EXCEPTION
    WHEN OTHERS THEN
        v_success := FALSE;
        DBMS_OUTPUT.PUT_LINE('Test 1 Failed: ' || SQLERRM);
END;
/

-- Test 2: Unsuccessful insertion
DECLARE
    v_error_caught BOOLEAN := FALSE;
BEGIN
    -- Attempt to insert an operation with an expected execution time exceeding the limit
    INSERT INTO Operation (Operation_ID, Operation_Type_ID, Expected_Estimated_Time)
    VALUES (2, 1, 200);
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -20001 THEN
            v_error_caught := TRUE;
            DBMS_OUTPUT.PUT_LINE('Test 2 Passed: Error raised for time limit');
            DBMS_OUTPUT.PUT_LINE('Error Message: ' || SQLERRM);
        ELSE
            DBMS_OUTPUT.PUT_LINE('Test 2 Failed: Unexpected error');
        END IF;
END;
/

-- Test 3: Successful update
DECLARE
    v_success BOOLEAN := TRUE;
BEGIN
    -- Update the expected execution time to a value within the allowed limit
    UPDATE Operation
    SET EXPECTED_ESTIMATED_TIME = 20
    WHERE Operation_ID = 1;
    DBMS_OUTPUT.PUT_LINE('Test 3 Passed: Update within limit');
EXCEPTION
    WHEN OTHERS THEN
        v_success := FALSE;
        DBMS_OUTPUT.PUT_LINE('Test 3 Failed: ' || SQLERRM);
END;
/

-- Test 4: Unsuccessful update
DECLARE
    v_error_caught BOOLEAN := FALSE;
BEGIN
    -- Attempt to update the expected execution time to a value exceeding the limit
    UPDATE Operation
    SET EXPECTED_ESTIMATED_TIME = 300
    WHERE Operation_ID = 1;
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -20001 THEN
            v_error_caught := TRUE;
            DBMS_OUTPUT.PUT_LINE('Test 4 Passed: Error raised for time limit');
            DBMS_OUTPUT.PUT_LINE('Error Message: ' || SQLERRM);
        ELSE
            DBMS_OUTPUT.PUT_LINE('Test 4 Failed: Unexpected error');
        END IF;
END;
/

-- Cleanup
DELETE FROM Workstation_Type_Operation_Type WHERE Workstation_Type_ID = 'WT1';
DELETE FROM Workstation_Type WHERE Workstation_Type_ID = 'WT1';
DELETE FROM Operation WHERE Operation_ID IN (1, 2);
DELETE FROM Operation_Type WHERE Operation_Type_ID = 1;