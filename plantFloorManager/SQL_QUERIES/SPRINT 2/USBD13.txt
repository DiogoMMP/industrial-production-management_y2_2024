CREATE OR REPLACE FUNCTION Get_Product_Operations (
    p_product_id IN VARCHAR2
) RETURN SYS_REFCURSOR IS
    -- Cursor to hold the combined operations data
    CURSOR c_operations IS
        SELECT
            boo.Product_ID AS Main_Product_ID,
            boo.Product_ID,
            boo.Operation_ID AS Manufacturing_Operation_ID,
            op.Operation_Type_ID,
            ot.Operation_Description,
            wto.Workstation_Type_ID,
            wt.Workstation_Type
        FROM BOO boo
        JOIN Operation op ON op.Operation_ID = boo.Operation_ID  -- Join with Operation table
        JOIN Operation_Type ot ON ot.Operation_Type_ID = op.Operation_Type_ID  -- Join with Operation_Type table
        LEFT JOIN Workstation_Type_Operation_Type wto ON wto.Operation_Type_ID = ot.Operation_Type_ID
        LEFT JOIN Workstation_Type wt ON wt.Workstation_Type_ID = wto.Workstation_Type_ID
        WHERE boo.Product_ID = p_product_id
        ORDER BY boo.Operation_ID;

    -- Variables to hold concatenated inputs and outputs
    v_inputs VARCHAR2(4000);
    v_outputs VARCHAR2(4000);

    -- Declare result collection
    v_result SYS.ODCIVARCHAR2LIST := SYS.ODCIVARCHAR2LIST();

    -- Declare ref cursor to return final result
    v_combined SYS_REFCURSOR;

BEGIN
    -- Loop through operations
    FOR op IN c_operations LOOP
        -- Initialize inputs and outputs
        v_inputs := '';
        v_outputs := '';

        -- Get Inputs for the operation
        FOR input_row IN (
            SELECT bi.Part_ID, bi.Quantity, p.Part_Description
            FROM BOO_Input bi
            JOIN Part p ON p.Part_ID = bi.Part_ID
            WHERE bi.Product_ID = op.Product_ID
            AND bi.Operation_ID = op.Manufacturing_Operation_ID
        ) LOOP
            v_inputs := v_inputs || input_row.Part_ID || ' (' || input_row.Quantity || ' ' || input_row.Part_Description || ')  ';
        END LOOP;

        -- Get Outputs for the operation
        FOR output_row IN (
            SELECT bo.Part_ID, bo.Quantity, p.Part_Description
            FROM BOO_Output bo
            JOIN Part p ON p.Part_ID = bo.Part_ID
            WHERE bo.Product_ID = op.Product_ID
            AND bo.Operation_ID = op.Manufacturing_Operation_ID
        ) LOOP
            v_outputs := v_outputs || output_row.Part_ID || ' (' || output_row.Quantity || ' ' || output_row.Part_Description || ')  ';
        END LOOP;

        -- Trim trailing spaces
        v_inputs := RTRIM(v_inputs);
        v_outputs := RTRIM(v_outputs);

        -- Store results in the result collection
        v_result.EXTEND;
        v_result(v_result.COUNT) :=
            'Main Product ID: ' || op.Main_Product_ID || CHR(10) ||
            'Product ID: ' || op.Product_ID || CHR(10) ||
            'Manufacturing Operation ID: ' || TO_CHAR(op.Manufacturing_Operation_ID) || CHR(10) ||
            'Operation Type ID: ' || TO_CHAR(op.Operation_Type_ID) || CHR(10) ||
            'Operation Description: ' || op.Operation_Description || CHR(10) ||
            'Workstation Type: ' || op.Workstation_Type || CHR(10) ||
            'Input Components: ' || v_inputs || CHR(10) ||
            'Output Components: ' || v_outputs || CHR(10) ||
            '------------------------' || CHR(10);
    END LOOP;

    -- Return the results as a ref cursor
    OPEN v_combined FOR
        SELECT column_value AS operation_data
        FROM TABLE(v_result);

    -- Return the ref cursor
    RETURN v_combined;

END Get_Product_Operations;


DECLARE
    v_result SYS_REFCURSOR;
    v_operation_data VARCHAR2(4000);
BEGIN
    v_result := Get_Product_Operations('AS12947S22'); -- Replace with your Product ID

    LOOP
        FETCH v_result INTO v_operation_data;
        EXIT WHEN v_result%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(v_operation_data);
    END LOOP;

    CLOSE v_result;
END;
/
