CREATE OR REPLACE FUNCTION Register_Customer_Order(
    p_customer_id        IN NUMBER,
    p_product_id         IN VARCHAR2,
    p_quantity           IN NUMBER,
    p_order_date         IN DATE,
    p_delivery_date      IN DATE,
	p_product_priority   IN VARCHAR2
) RETURN NUMBER IS
    v_customer_order_id  NUMBER;
    v_active_status      VARCHAR2(255);
    v_product_exists     NUMBER;
	v_customer_exists    NUMBER;
BEGIN

     -- Check if customer exists
    Select Customer_id INTO v_customer_exists
    FROM Customer
    WHERE Customer_ID = p_customer_id;

	IF v_customer_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Customer doesn''t exist.');
	END IF;

     -- Check if the order date is before the current date
    IF p_order_date < SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20002, 'Order date cannot be before today''s date.');
    END IF;

	-- Check if the delivery date is after the new order date
	IF p_delivery_date < p_order_date THEN
        RAISE_APPLICATION_ERROR(-20003, 'Delivery date can''t be before new order date');
	END IF;

    -- Step 1: Check if the customer is active
    SELECT Status INTO v_active_status
    FROM Customer
    WHERE Customer_ID = p_customer_id;

    IF v_active_status != 'Activated' THEN
        RAISE_APPLICATION_ERROR(-20004, 'Customer is not active.');
    END IF;

    -- Step 2: Check if the product exists in the current lineup
    SELECT COUNT(*)
    INTO v_product_exists
    FROM Product
    WHERE Product_ID = p_product_id;

    IF v_product_exists = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, 'Product does not exist in the current lineup.');
    END IF;

    -- Step 3: Insert into Customer_Order
	Select max(Customer_Order_ID) + 1 into v_customer_order_id from customer_order;


    INSERT INTO Customer_Order (
        Customer_Order_ID, Order_Date, Delivery_Date, Customer_ID
    ) VALUES (
        v_customer_order_id, p_order_date, p_delivery_date, p_customer_id
    );

    -- Step 4: Insert into Customer_Order_Product
    INSERT INTO Customer_Order_Product (
        Customer_Order_ID, Product_ID, Quantity, Product_Priority
    ) VALUES (
        v_customer_order_id, p_product_id, p_quantity, p_product_priority
    );

    -- Return the new Customer_Order_ID
    RETURN v_customer_order_id;

EXCEPTION
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20006, 'Error creating order: ' || SQLERRM);
END;
/


    --Valid test
DECLARE
    v_order_id NUMBER;
BEGIN
    -- Test the Register_Customer_Order function
    v_order_id := Register_Customer_Order(
        p_customer_id   => 456,         	-- Customer_ID
        p_product_id    => 'AS12945S22',    -- Product_ID
        p_quantity      => 10,           	-- Example quantity
        p_order_date    => SYSDATE,      	-- Date for the order
        p_delivery_date => SYSDATE + 7, 	-- Delivery date
    	p_product_priority => 'High'		-- Product priority
    );

    DBMS_OUTPUT.PUT_LINE('Order created successfully. Order ID: ' || v_order_id);
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

    --Test with wrong product
DECLARE
    v_order_id NUMBER;
BEGIN
    -- Test the Register_Customer_Order function
    v_order_id := Register_Customer_Order(
        p_customer_id   => 456,         	-- Customer_ID
        p_product_id    => 'invalid',    	-- Product_ID
        p_quantity      => 10,           	-- Example quantity
        p_order_date    => SYSDATE,      	-- Date for the order
        p_delivery_date => SYSDATE + 7,  	-- Delivery date
    	p_product_priority => 'High'		-- Product priority
    );

    DBMS_OUTPUT.PUT_LINE('Order created successfully. Order ID: ' || v_order_id);
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

    --Test with invalid customer
DECLARE
    v_order_id NUMBER;
BEGIN
    -- Test the Register_Customer_Order function
    v_order_id := Register_Customer_Order(
        p_customer_id   => 999,         	-- Customer_ID
        p_product_id    => 'AS12945S22',    -- Product_ID
        p_quantity      => 10,           	-- Example quantity
        p_order_date    => SYSDATE,      	-- Date for the order
        p_delivery_date => SYSDATE + 7,  	-- Delivery date
    	p_product_priority => 'High'		-- Product priority
    );

    DBMS_OUTPUT.PUT_LINE('Order created successfully. Order ID: ' || v_order_id);
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/


    --Test with invalid date
DECLARE
    v_order_id NUMBER;
BEGIN
    -- Test the Register_Customer_Order function
    v_order_id := Register_Customer_Order(
        p_customer_id   => 456,         	-- Customer_ID
        p_product_id    => 'AS12945S22',    -- Product_ID
        p_quantity      => 10,           	-- Example quantity
        p_order_date    => SYSDATE - 2,     -- Date for the order
        p_delivery_date => SYSDATE + 7,  	-- Delivery date
    	p_product_priority => 'High'		-- Product priority
    );

    DBMS_OUTPUT.PUT_LINE('Order created successfully. Order ID: ' || v_order_id);
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

    --Test with invalid date
DECLARE
    v_order_id NUMBER;
BEGIN
    -- Test the Register_Customer_Order function
    v_order_id := Register_Customer_Order(
        p_customer_id   => 456,         	-- Customer_ID
        p_product_id    => 'AS12945S22',    -- Product_ID
        p_quantity      => 10,           	-- Example quantity
        p_order_date    => SYSDATE,      	-- Date for the order
        p_delivery_date => SYSDATE - 2,      -- Delivery date
    	p_product_priority => 'High'		-- Product priority
    );

    DBMS_OUTPUT.PUT_LINE('Order created successfully. Order ID: ' || v_order_id);
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

    --Test with invalid costumer
DECLARE
    v_order_id NUMBER;
BEGIN
    -- Test the Register_Customer_Order function
    v_order_id := Register_Customer_Order(
        p_customer_id   => 1000,         	-- Customer_ID
        p_product_id    => 'AS12945S22',    -- Product_ID
        p_quantity      => 10,           	-- Example quantity
        p_order_date    => SYSDATE,      	-- Date for the order
        p_delivery_date => SYSDATE + 7,      -- Delivery date
    	p_product_priority => 'High'		-- Product priority
    );

    DBMS_OUTPUT.PUT_LINE('Order created successfully. Order ID: ' || v_order_id);
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/
