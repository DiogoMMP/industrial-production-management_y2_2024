CREATE OR REPLACE FUNCTION Get_Product_Parts (p_Product_ID IN VARCHAR2)
RETURN SYS_REFCURSOR
AS
    part_cursor SYS_REFCURSOR;
BEGIN
    OPEN part_cursor FOR
        -- Select the main product (product itself), with Part_ID as Product_ID
        SELECT
            TO_CHAR(pr.Product_ID) AS Product_ID,
            TO_CHAR(pr.Product_ID) AS Part_ID,
            TO_CHAR(pa.Part_Description) AS Part_Description,
            1 AS Quantity,
            TO_CHAR(pr.Product_ID) AS Subpart_ID,
            'Product' AS Subpart_Type
        FROM
            Product pr
            JOIN Part pa ON pr.Part_ID = pa.Part_ID
        WHERE
            pr.Product_ID = p_Product_ID

        UNION ALL

        -- Select products that are used as parts in the given product
        SELECT
            TO_CHAR(pr.Product_ID) AS Product_ID,
            TO_CHAR(ip.Product_ID) AS Part_ID,
            TO_CHAR(pa.Part_Description) AS Part_Description,
            TO_NUMBER(boo_in.Quantity) AS Quantity,
            TO_CHAR(ip.Product_ID) AS Subpart_ID,
            'Product' AS Subpart_Type
        FROM
            Product pr
            JOIN BOO boo ON pr.Product_ID = boo.Product_ID
            JOIN BOO_Input boo_in ON boo.Product_ID = boo_in.Product_ID AND boo.Operation_ID = boo_in.Operation_ID
            JOIN Product ip ON boo_in.Part_ID = ip.Product_ID
            JOIN Part pa ON boo_in.Part_ID = pa.Part_ID
        WHERE
            pr.Product_ID = p_Product_ID

        UNION ALL

        -- Select intermediate products
        SELECT
            TO_CHAR(pr.Product_ID) AS Product_ID,
            TO_CHAR(ip.Part_ID) AS Part_ID,
            TO_CHAR(pa.Part_Description) AS Part_Description,
            TO_NUMBER(boo_in.Quantity) AS Quantity,
            TO_CHAR(ip.Part_ID) AS Subpart_ID,
            'Intermediate Product' AS Subpart_Type
        FROM
            Product pr
            JOIN BOO boo ON pr.Product_ID = boo.Product_ID
            JOIN BOO_Input boo_in ON boo.Product_ID = boo_in.Product_ID AND boo.Operation_ID = boo_in.Operation_ID
            JOIN Part pa ON boo_in.Part_ID = pa.Part_ID
            JOIN Intermediate_Product ip ON pa.Part_ID = ip.Part_ID
        WHERE
            pr.Product_ID = p_Product_ID

        UNION ALL

        -- Select components
        SELECT
            TO_CHAR(pr.Product_ID) AS Product_ID,
            TO_CHAR(boo_in.Part_ID) AS Part_ID,
            TO_CHAR(pa.Part_Description) AS Part_Description,
            TO_NUMBER(boo_in.Quantity) AS Quantity,
            TO_CHAR(pa.Part_ID) AS Subpart_ID,
            'Component' AS Subpart_Type
        FROM
            Product pr
            JOIN BOO boo ON pr.Product_ID = boo.Product_ID
            JOIN BOO_Input boo_in ON boo.Product_ID = boo_in.Product_ID AND boo.Operation_ID = boo_in.Operation_ID
            JOIN Part pa ON boo_in.Part_ID = pa.Part_ID
            JOIN Component cp ON pa.Part_ID = cp.Part_ID
        WHERE
            pr.Product_ID = p_Product_ID

        UNION ALL

        -- Select raw materials
        SELECT
            TO_CHAR(pr.Product_ID) AS Product_ID,
            TO_CHAR(boo_in.Part_ID) AS Part_ID,
            TO_CHAR(pa.Part_Description) AS Part_Description,
            TO_NUMBER(boo_in.Quantity) AS Quantity,
            TO_CHAR(pa.Part_ID) AS Subpart_ID,
            'Raw Material' AS Subpart_Type
        FROM
            Product pr
            JOIN BOO boo ON pr.Product_ID = boo.Product_ID
            JOIN BOO_Input boo_in ON boo.Product_ID = boo_in.Product_ID AND boo.Operation_ID = boo_in.Operation_ID
            JOIN Part pa ON boo_in.Part_ID = pa.Part_ID
            JOIN Raw_Material rm ON pa.Part_ID = rm.Part_ID
        WHERE
            pr.Product_ID = p_Product_ID;

    RETURN part_cursor;
END;


DECLARE
    -- Declare the cursor to store the result
    parts_cursor SYS_REFCURSOR;

    -- Declare variables to store fetched values
    product_id VARCHAR2(255);
    part_id VARCHAR2(255);
    part_desc VARCHAR2(255);
    subpart_id VARCHAR2(255);
    subpart_type VARCHAR2(255);
    total_qty NUMBER; -- Variable to store quantity
BEGIN
    -- Set the product ID (for testing, we use a specific known product ID)
    product_id := 'AS12947S22';

    -- Call the function and get the cursor (assuming Get_Product_Parts is defined and works correctly)
    parts_cursor := Get_Product_Parts(product_id);

    -- Fetch and display each part
    LOOP
        -- Fetch data including Product_ID and other columns
        FETCH parts_cursor INTO product_id, part_id, part_desc, total_qty, subpart_id, subpart_type;

        -- Exit the loop when no more rows are found
        EXIT WHEN parts_cursor%NOTFOUND;

        -- Output the result
        DBMS_OUTPUT.PUT_LINE('Product ID: ' || product_id);
        DBMS_OUTPUT.PUT_LINE('Part ID: ' || part_id);
        DBMS_OUTPUT.PUT_LINE('Description: ' || part_desc);
        DBMS_OUTPUT.PUT_LINE('Quantity: ' || total_qty);
        DBMS_OUTPUT.PUT_LINE('Subpart Type: ' || subpart_type);
        DBMS_OUTPUT.PUT_LINE('Subpart ID: ' || subpart_id);

        DBMS_OUTPUT.PUT_LINE('--------------------------------------------------------------------------------');
    END LOOP;

    -- Close the cursor after use
    CLOSE parts_cursor;
END;
