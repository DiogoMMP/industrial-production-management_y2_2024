-- First, after the creation of the tables, we need to create the procedure that will deactivate a customer


CREATE OR REPLACE FUNCTION Deactivate_Customer (p_Customer_ID NUMBER) RETURN VARCHAR2 IS
    v_Pending_Orders NUMBER := 0;
    v_Result VARCHAR2(200);
    v_Current_Status VARCHAR2(50);
BEGIN
    -- Check the current status of the customer
    SELECT Status INTO v_Current_Status
    FROM Customer
    WHERE Customer_ID = p_Customer_ID;

    -- If the customer is already deactivated, return a message
    IF v_Current_Status = 'Deactivated' THEN
        v_Result := 'Error: Customer is already deactivated.';
        RETURN v_Result;
    END IF;

    -- Check if there are any pending or undelivered orders for the customer
    SELECT COUNT(*) INTO v_Pending_Orders
    FROM Customer_Order
    WHERE Customer_ID = p_Customer_ID;

    -- If no pending orders, update the status to "Inactive"
    IF ((v_Pending_Orders = 0) OR (v_Pending_Orders IS NULL)) THEN
        UPDATE Customer
        SET Status = 'Deactivated'
        WHERE Customer_ID = p_Customer_ID;
        v_Result := 'Customer successfully deactivated.';
    ELSE
        v_Result := 'Error: Customer has pending or undelivered orders and cannot be deactivated.';
    END IF;

    RETURN v_Result;
END;


-- Test the function with a hardcoded customer ID, where it will not deactivate the customer

DECLARE
    ID_TO_Deactivate NUMBER(10) := 785; -- Replace with the desired customer ID for testing
    v_Result VARCHAR2(200);
BEGIN
    -- Call the function and store the result
    v_Result := Deactivate_Customer(ID_TO_Deactivate);

    -- Display the result
    DBMS_OUTPUT.PUT_LINE(v_Result);
END;

-- Extra data to test the function with a customer that can be deactivated

insert into Customer(Customer_ID, NIF, Name, Address, Mobile_number, Email, type_ID, Country_ID, Status) values ('400', 'CZ6451237810', 'U Fleku', 'Křemencova 11, 110 00 Nové Město, Czechia', 004201234567, 'some.random@email.cz', 1, 203, 'Activated');

-- Test the function with a hardcoded customer ID, where it will deactivate the customer

DECLARE
    ID_TO_Deactivate NUMBER(10) := 400; -- Replace with the desired customer ID for testing
    v_Result VARCHAR2(200);
BEGIN
    -- Call the function and store the result
    v_Result := Deactivate_Customer(ID_TO_Deactivate);

    -- Display the result
    DBMS_OUTPUT.PUT_LINE(v_Result);
END;

-- Extra data to test the function with a customer that is already deactivated

insert into Customer(Customer_ID, NIF, Name, Address, Mobile_number, Email, type_ID, Country_ID, Status) values ('200', 'CZ6451237810', 'U Fleku', 'Křemencova 11, 110 00 Nové Město, Czechia', 004201234567, 'some.random@email.cz', 1, 203, 'Deactivated');

-- Test the function with a hardcoded customer ID, where the customer is already deactivated

DECLARE
    ID_TO_Deactivate NUMBER(10) := 200; -- Replace with the desired customer ID for testing
    v_Result VARCHAR2(200);
BEGIN
    -- Call the function and store the result
    v_Result := Deactivate_Customer(ID_TO_Deactivate);

    -- Display the result
    DBMS_OUTPUT.PUT_LINE(v_Result);
END;