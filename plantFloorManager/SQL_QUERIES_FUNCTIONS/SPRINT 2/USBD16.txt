CREATE OR REPLACE FUNCTION add_product(
    p_product_id          IN Product.Product_ID%TYPE,
    p_product_name        IN Product.Product_Name%TYPE,
    p_part_description    IN Part.Part_Description%TYPE,
    p_factory_plant_id    IN Product.Factory_Plant_ID%TYPE,
    p_market_demand       IN Product.Market_Demand%TYPE DEFAULT NULL,
    p_optimization        IN Product.Optimization%TYPE DEFAULT NULL,
    p_production_cost     IN Product.Production_Cost%TYPE DEFAULT NULL,
    p_flexibility         IN Product.Flexibility%TYPE DEFAULT NULL,
    p_family_id           IN Product.Family_ID%TYPE
) RETURN VARCHAR2 IS
    v_result VARCHAR2(500) := 'Inserted successfully';
    dummy NUMBER(10);

    -- Exception declarations
    PRODUCT_EXIST EXCEPTION;
	PART_EXIST EXCEPTION;
    PRODUCT_FAMILY_NOT_EXIST EXCEPTION;
    PRODUCT_FACTORY_NOT_EXIST EXCEPTION;
    PRODUCT_NAME_NULL EXCEPTION;
    PRODUCT_DESCRIPTION_NULL EXCEPTION;
    PRODUCT_ID_NULL EXCEPTION;
    FACTORY_PLANT_ID_NULL EXCEPTION;
    FAMILY_ID_NULL EXCEPTION;

BEGIN
    -- Validate mandatory fields are not NULL
    IF p_product_id IS NULL THEN
        RAISE PRODUCT_ID_NULL;
    END IF;

    IF p_product_name IS NULL THEN
        RAISE PRODUCT_NAME_NULL;
    END IF;

    IF p_part_description IS NULL THEN
        RAISE PRODUCT_DESCRIPTION_NULL;
    END IF;

    IF p_factory_plant_id IS NULL THEN
        RAISE FACTORY_PLANT_ID_NULL;
    END IF;

    IF p_family_id IS NULL THEN
        RAISE FAMILY_ID_NULL;
    END IF;

	-- Check if the product already exists
	SELECT COUNT(*) INTO dummy
    FROM Product
    WHERE Product_ID = p_product_id;

	IF dummy > 0 THEN
        RAISE PRODUCT_EXIST;
    END IF;

    -- Check if the part already exists
    SELECT COUNT(*) INTO dummy
    FROM Part
    WHERE Part_ID = p_product_id;

    IF dummy > 0 THEN
        RAISE PART_EXIST;
    END IF;

    -- Check if the family ID exists
    SELECT COUNT(*) INTO dummy
    FROM Product_Family
    WHERE Family_ID = p_family_id;

    IF dummy = 0 THEN
        RAISE PRODUCT_FAMILY_NOT_EXIST;
    END IF;

    -- Check if the factory plant ID exists
    SELECT COUNT(*) INTO dummy
    FROM Factory_Plant
    WHERE Factory_Plant_ID = p_factory_plant_id;

    IF dummy = 0 THEN
        RAISE PRODUCT_FACTORY_NOT_EXIST;
    END IF;

    -- Insert the new product as a part
    INSERT INTO Part (Part_ID, Part_Description)
    VALUES (p_product_id, p_part_description);

    INSERT INTO Internal_Part (Part_ID) VALUES (p_product_id);

    -- Insert the new product
    INSERT INTO Product (
        Product_ID, Product_Name, Factory_Plant_ID,
        Market_Demand, Optimization, Production_Cost, Flexibility,
        Family_ID
    ) VALUES (
        p_product_id, p_product_name, p_factory_plant_id,
        p_market_demand, p_optimization, p_production_cost, p_flexibility,
        p_family_id
    );

    -- Commit the transaction
    COMMIT;

    -- Return success message
    RETURN v_result;

EXCEPTION
    WHEN PRODUCT_EXIST THEN
    	ROLLBACK;
		RETURN 'Error: Product with ID "' || p_product_id || '" already exists.';
    WHEN PART_EXIST THEN
        ROLLBACK;
        RETURN 'Error: Part with ID "' || p_product_id || '" already exists.';
    WHEN PRODUCT_FAMILY_NOT_EXIST THEN
        ROLLBACK;
        RETURN 'Error: Family with ID "' || p_family_id || '" does not exist.';
    WHEN PRODUCT_FACTORY_NOT_EXIST THEN
        ROLLBACK;
        RETURN 'Error: Factory Plant with ID "' || p_factory_plant_id || '" does not exist.';
    WHEN PRODUCT_NAME_NULL THEN
        ROLLBACK;
        RETURN 'Error: Product Name cannot be NULL.';
    WHEN PRODUCT_DESCRIPTION_NULL THEN
        ROLLBACK;
        RETURN 'Error: Product Description cannot be NULL.';
    WHEN FACTORY_PLANT_ID_NULL THEN
        ROLLBACK;
        RETURN 'Error: Factory Plant ID cannot be NULL.';
    WHEN FAMILY_ID_NULL THEN
        ROLLBACK;
        RETURN 'Error: Family ID cannot be NULL.';
    WHEN PRODUCT_ID_NULL THEN
        ROLLBACK;
        RETURN 'Error: Product ID cannot be NULL.';
    WHEN OTHERS THEN
        ROLLBACK;
        RETURN 'Not inserted: ' || SQLERRM;
END add_product;
/





-- Test the add_product function

-- Scenario 1: Successful insertion
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'PN52384R50', -- Product ID
        'xx', -- Product Name
        'xx', -- Part Description
        1, -- Factory Plant ID
        12, -- Market Demand
        12, -- Optimization
        12, -- Production Cost
        12, -- Flexibility
        125 -- Family ID
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 1 - Successful Insertion: ' || v_result);
END;
/


-- Scenario 2: Duplicate Product_ID
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'P001', -- Duplicate Product ID
        'Another Product', -- Product Name
        'Another Description', -- Part Description
        1, -- Factory Plant ID
        200, -- Market Demand
        50, -- Optimization
        300, -- Production Cost
        40, -- Flexibility
        125 -- Family ID
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 2 - Duplicate Product_ID: ' || v_result);
END;
/


-- Scenario 3: Null Product Name (should fail)
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'P002', -- Product ID
        NULL, -- Product Name (should fail)
        'Valid Description', -- Part Description
        1, -- Factory Plant ID
        100, -- Market Demand
        80, -- Optimization
        200, -- Production Cost
        50, -- Flexibility
        125 -- Family ID
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 3 - Null Product Name: ' || v_result);
END;
/


-- Scenario 4: Null Part Description (should fail)
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'P003', -- Product ID
        'Product Without Description', -- Product Name
        NULL, -- Part Description (should fail)
        1, -- Factory Plant ID
        100, -- Market Demand
        80, -- Optimization
        200, -- Production Cost
        50, -- Flexibility
        125 -- Family ID
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 4 - Null Part Description: ' || v_result);
END;
/


-- Scenario 5: Invalid Factory Plant ID (should fail)
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'P005', -- Product ID
        'Product Invalid Plant', -- Product Name
        'Description Invalid Plant', -- Part Description
        99, -- Invalid Factory Plant ID
        120, -- Market Demand
        70, -- Optimization
        400, -- Production Cost
        60, -- Flexibility
        125 -- Family ID
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 5 - Invalid Factory_Plant_ID: ' || v_result);
END;
/


-- Scenario 6: Null Family ID (should fail)
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'P007', -- Product ID
        'Product Without Family', -- Product Name
        'Description Without Family', -- Part Description
        1, -- Factory Plant ID
        100, -- Market Demand
        50, -- Optimization
        200, -- Production Cost
        30, -- Flexibility
        NULL -- Family ID (should fail)
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 6 - Null Family ID: ' || v_result);
END;
/


-- Scenario 7: Non-existing Family ID (should fail)
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'P008', -- Product ID
        'Product Non-Existing Family', -- Product Name
        'Description Non-Existing Family', -- Part Description
        1, -- Factory Plant ID
        80, -- Market Demand
        40, -- Optimization
        180, -- Production Cost
        25, -- Flexibility
        9999 -- Non-existing Family ID
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 7 - Non-existing Family ID: ' || v_result);
END;
/


-- Scenario 8: Successful insertion with default values
DECLARE
    v_result VARCHAR2(500);
BEGIN
    v_result := add_product(
        'P009', -- Product ID
        'Default Values Product', -- Product Name
        'Description Default Values', -- Part Description
        1, -- Factory Plant ID
        NULL, -- Market Demand (default)
        NULL, -- Optimization (default)
        NULL, -- Production Cost (default)
        NULL, -- Flexibility (default)
        125 -- Family ID
    );
    DBMS_OUTPUT.PUT_LINE('Scenario 8 - Successful Insertion with Defaults: ' || v_result);
END;
/


