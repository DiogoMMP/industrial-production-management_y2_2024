CREATE OR REPLACE FUNCTION get_product_parts (
    p_Product_ID IN Product.Product_ID%TYPE
)
    RETURN SYS_REFCURSOR
    IS
    v_cursor SYS_REFCURSOR;
    dummy NUMBER(10);

    -- Exception declarations for validation
    NULL_PRODUCT_ID EXCEPTION;
    PRODUCT_NOT_FOUND EXCEPTION;

BEGIN

    -- Check if the Product_ID is NULL
    IF p_Product_ID IS NULL THEN
        RAISE NULL_PRODUCT_ID;
    END IF;

    -- Check if the Product_ID exists in the PRODUCT table
    SELECT COUNT(*) INTO dummy
    FROM PRODUCT
    WHERE Product_ID = p_Product_ID;

    -- If no rows found, raise PRODUCT_NOT_FOUND exception
    IF dummy = 0 THEN
        RAISE PRODUCT_NOT_FOUND;
    END IF;

    -- Open cursor to fetch parts related to the product
    OPEN v_cursor FOR
        SELECT
            BI.Part_ID,
            P.Part_Description AS Part_Description, -- Fetch description from the Part table
            CASE
                WHEN IP.Part_ID IS NOT NULL THEN 'Intermediate Product'
                WHEN C.Part_ID IS NOT NULL THEN 'Component'
                WHEN RM.Part_ID IS NOT NULL THEN 'Raw Material'
                ELSE 'Unknown'
                END AS Part_Type,
            SUM(BI.Quantity) AS Total_Quantity
        FROM BOO_Input BI
                 LEFT JOIN Intermediate_Product IP ON BI.Part_ID = IP.Part_ID
                 LEFT JOIN Component C ON BI.Part_ID = C.Part_ID
                 LEFT JOIN Raw_Material RM ON BI.Part_ID = RM.Part_ID
                 LEFT JOIN Part P ON BI.Part_ID = P.Part_ID  -- Join with Part table to fetch description
        WHERE BI.Product_ID = p_Product_ID
        GROUP BY BI.Part_ID, P.Part_Description, IP.Part_ID, C.Part_ID, RM.Part_ID;

    RETURN v_cursor;

EXCEPTION
    -- Handle exceptions for null Product_ID and non-existing Product_ID
    WHEN NULL_PRODUCT_ID THEN
        RAISE_APPLICATION_ERROR(-20001, 'Error: Product ID cannot be NULL');
    WHEN PRODUCT_NOT_FOUND THEN
        RAISE_APPLICATION_ERROR(-20002, 'Error: Product with ID "' || p_Product_ID || '" does not exist');
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20003, 'Error: An unexpected error occurred: ' || SQLERRM);
    RETURN NULL; -- Ensure a return statement in case of exceptions
END get_product_parts;


-- Test the function with different scenarios

-- Scenario 1: Call the function with a NULL Product_ID
DECLARE
    v_cursor SYS_REFCURSOR;
BEGIN
    -- Try to call the function with a NULL Product_ID
    BEGIN
        -- Passing NULL to trigger the exception
        v_cursor := get_product_parts(NULL);
    EXCEPTION
        WHEN OTHERS THEN
            -- Catch the exception and display the error message
            DBMS_OUTPUT.PUT_LINE('Scenario 1 - Null Product ID: ' || SQLERRM);
            -- Expected output: Error: Product ID cannot be NULL
    END;
END;

-- Scenario 2: Call the function with a non-existent Product_ID
DECLARE
    v_cursor SYS_REFCURSOR;
BEGIN
    -- Try to call the function with a non-existent Product_ID
    BEGIN
        -- Replace 'NONEXISTENT_ID' with an ID that does not exist in your database
        v_cursor := get_product_parts('NONEXISTENT_ID');
    EXCEPTION
        WHEN OTHERS THEN
            -- Catch the exception and display the error message
            DBMS_OUTPUT.PUT_LINE('Scenario 2 - Non-existent Product ID: ' || SQLERRM);
            -- Expected output: Error: Product with ID "NONEXISTENT_ID" does not exist
    END;
END;

-- Scenario 3: Call the function with an existing Product_ID
DECLARE
    v_cursor SYS_REFCURSOR;
    v_Part_ID VARCHAR2(50);
    v_Part_Description VARCHAR2(255);
    v_Part_Type VARCHAR2(30);
    v_Total_Quantity NUMBER;
BEGIN
    -- Call the function with an example of Product_ID
    v_cursor := GET_PRODUCT_PARTS('AS12947S22');

	DBMS_OUTPUT.PUT_LINE('Scenario 3: Successfully');
	DBMS_OUTPUT.PUT_LINE(CHR(10));

    LOOP
        FETCH v_cursor INTO v_Part_ID, v_Part_Description, v_Part_Type, v_Total_Quantity;
        EXIT WHEN v_cursor%NOTFOUND; -- Exits the loop when there are no more results

        -- Exibe os resultados formatados
        DBMS_OUTPUT.PUT_LINE('Part ID: ' || v_Part_ID);
        DBMS_OUTPUT.PUT_LINE('Part Description: ' || v_Part_Description);
        DBMS_OUTPUT.PUT_LINE('Part Type: ' || v_Part_Type);
        DBMS_OUTPUT.PUT_LINE('Quantity: ' || v_Total_Quantity);
        DBMS_OUTPUT.PUT_LINE('---------------------------------------------------------');
    END LOOP;

    CLOSE v_cursor; -- Closes the cursor after use
END;




